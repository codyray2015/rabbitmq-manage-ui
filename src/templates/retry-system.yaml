template:
  name: retry-system
  version: "1.0"
  description: å®Œæ•´çš„å»¶è¿Ÿé‡è¯•é˜Ÿåˆ—ç³»ç»Ÿï¼ŒåŒ…å«ä¸»é˜Ÿåˆ—ã€é‡è¯•é˜Ÿåˆ—ã€äº¤æ¢æœºå’Œç»‘å®šå…³ç³»ï¼ˆåŸºäºQuorumé˜Ÿåˆ—ï¼‰
  author: cody-ozon
  icon: "ğŸ”„"
  tags:
    - retry
    - quorum
    - system
    - production

parameters:
  - name: queue_prefix
    label: é˜Ÿåˆ—ä¸šåŠ¡åç§°å‰ç¼€
    type: string
    required: true
    description: é˜Ÿåˆ—çš„ä¸šåŠ¡æ ‡è¯†å‰ç¼€ï¼Œå¦‚ 'order-service'
    validation:
      pattern: "^[a-zA-Z0-9_-]+$"

  - name: vhost
    label: Virtual Host
    type: select
    required: true
    description: RabbitMQè™šæ‹Ÿä¸»æœº
    dataSource:
      type: vhosts

  - name: main_exchange
    label: ä¸»äº¤æ¢æœºåç§°
    type: combobox
    required: true
    description: "å¯ä»¥é€‰æ‹©ç°æœ‰çš„ topic ç±»å‹äº¤æ¢æœºï¼Œæˆ–è¾“å…¥æ–°çš„äº¤æ¢æœºåç§°ï¼ˆå»ºè®®æ ¼å¼: ä¸šåŠ¡å‰ç¼€.exchangeï¼‰ã€‚æ³¨æ„ï¼šä¸èƒ½ä½¿ç”¨ç©ºå­—ç¬¦ä¸²æˆ–ç³»ç»Ÿå†…ç½®äº¤æ¢æœºï¼ˆamq.*ï¼‰"
    dataSource:
      type: exchanges
      dependsOn: vhost
      filter:
        type: topic
        durable: true

  - name: routing_key
    label: Routing Key
    type: string
    required: true
    default: "#"
    description: "ä¸»é˜Ÿåˆ—ç»‘å®šåˆ°ä¸»äº¤æ¢æœºçš„è·¯ç”±é”®ï¼ˆé»˜è®¤ # åŒ¹é…æ‰€æœ‰æ¶ˆæ¯ï¼‰"

  - name: retry_delay_ms
    label: é‡è¯•å»¶è¿Ÿæ—¶é—´ (æ¯«ç§’)
    type: number
    required: true
    default: 60000
    description: é‡è¯•é˜Ÿåˆ—çš„æ¶ˆæ¯TTLï¼Œåˆ°æœŸåé‡æ–°è·¯ç”±åˆ°ä¸»é˜Ÿåˆ—ï¼Œé»˜è®¤60ç§’
    validation:
      min: 1000
      max: 86400000

# äº¤æ¢æœºå®šä¹‰
exchanges:
  - name: "${main_exchange}"
    type: "topic"
    durable: true
    auto_delete: false
    reuseIfExists: true
    validateIfExists:
      type: "topic"
      durable: true

  - name: "${queue_prefix}.retry.dlx"
    type: "topic"
    durable: true
    auto_delete: false

# é˜Ÿåˆ—å®šä¹‰
queues:
  - name: "${queue_prefix}"
    vhost: "${vhost}"
    durable: true
    auto_delete: false
    arguments:
      x-queue-type: "quorum"
      x-dead-letter-exchange: "${queue_prefix}.retry.dlx"
      x-dead-letter-routing-key: "${queue_prefix}.retry"

  - name: "${queue_prefix}.retry"
    vhost: "${vhost}"
    durable: true
    auto_delete: false
    arguments:
      x-queue-type: "quorum"
      x-message-ttl: ${retry_delay_ms}
      x-dead-letter-exchange: "${main_exchange}"
      x-dead-letter-routing-key: "${routing_key}"

# ç»‘å®šå…³ç³»
bindings:
  - source: "${main_exchange}"
    destination: "${queue_prefix}"
    destination_type: "queue"
    routing_key: "${routing_key}"

  - source: "${queue_prefix}.retry.dlx"
    destination: "${queue_prefix}.retry"
    destination_type: "queue"
    routing_key: "${queue_prefix}.retry"
